---
title: "Introduction to OutSeekR"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to OutSeekR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(OutSeekR)
```

# Introduction

The **OutSeekR** package implements a statistical approach to detecting outliers in RNA-seq and related data.

*[An overview of existing approaches to outlier detection and why this new method is necessary]*

# Methodology

An analysis using **OutSeekR** should start with a matrix or data frame of normalized RNA-seq data, e.g., fragments per kilobase of transcript per million fragments mapped (FPKM), or similar type of data; in the case of RNA-seq data, we require normalized values rather than the counts themselves because the statistics we calculate assume continuous data. For simplicity, we'll refer to the rows of the input data set as 'transcripts' and the columns of the input data set as 'samples'. Transcript identifiers should be stored as the row names of the matrix or data frame, and sample identifiers should be stored as the column names.

The statistical approach of **OutSeekR** centers around the use of five statistics calculated for each transcript in the observed data:
1. the range of standard scores (z-scores) computed using the mean and standard deviation;
2. the range of z-scores computed using the median and median absolute deviation (MAD);
3. the range of z-scores computed using the 5%-trimmed mean and 5%-trimmed standard deviation;
4. the fraction of observations assigned to the smaller cluster based on K-means clustering with K = 2 clusters; and
5. the cosine similarity between the most extreme observed value and the largest quantile of a representative theoretical distribution (see [Simulating null data]).
Specifically, it uses five statistics calculated on the observed data and compares the distributions of these statistics with counterparts calculated using simulated null data. Observed data yielding statistics more extreme than those of the null data suggest the presence of outliers.

## Overview

As an overview, the **OutSeekR** algorithm does the following:

- Simulates null data designed to share the characteristics of the observed data but without outlying values.
- Calculates the five statistics on each transcript in the observed data and each simulated transcript in the null data.
- For each transcript:
  - Combines the five statistics for this observed transcript with the five statistics from the null data.
  - Ranks each of the five vectors of statistics individually.
  - Computes the rank product for the observed transcript and each null transcript, defined as $$\sqrt[k]{\prod_{i=1}^k Rank_i},$$ where $k$ is the number of nonmissing ranks.
  - Computes a p-value as the proportion of rank products among the null transcripts greater than the rank product for the observed transcript. This p-value corresponds to the outlier test for the sample with the **most extreme value** in the observed transcript. If the p-value indicates this sample is an outlier, we exclude this sample, recalculate the outlier statistics in the remaining samples, combine these recalculated statistics with those computed from the null transcripts, recompute the rank product, and compute the new p-value. We continue in this fashion until we find a nonsignificant p-value (or, more precisely, a p-value greater than a user-specified threshold); each subsequent sample will be less outlying than the current one, so no more outliers are present, and we continue with the next transcript.
- Combines results across transcripts and performs p-value adjustment.

## Simulating null data

We hypothesize that the underlying data can be represented by one of four theoretical distributions: the normal, log-normal, exponential, or gamma distributions. For each transcript, we fit a generalized additive model for location, scale, and shape (GAMLSS) to the observed data based on each distribution using `gamlss()` from the [**gamlss**](https://www.gamlss.com/) package; the model with the smallest Bayesian Information Criterion corresponds to the optimal theoretical distribution for the transcript. To account for additional variability, we also calculate 'residuals' for each transcript as the differences between the empirical quantiles of the observed data and the quantiles of the optimal theoretical distribution. Using the same GAMLSS-based method, we identify the optimal distribution of these residuals from among the normal, log-normal, exponential, or gamma. (Note that the optimal distributions of a transcript and its residuals need not be the same.)

With the optimal distribution of each observed transcript and its residuals, we can create the simulated data. We iterate a user-specified number of times---one million by default. At each step, we randomly select a transcript from the observed data and generate as many values as there are samples in the observed data according to its optimal distribution. We then add noise based on the optimal distribution of its residuals. The final null transcript is the sum of the simulated values and the simulated residuals. The final data set of simulated transcripts will contain as many rows as transcripts were selected and the same number of columns as the observed data.

The null data do not contain outliers by construction but are still in some sense representative of the observed data. By calculating the five outlier statistics on these transcripts, we can get a sense of their distributions in data similar to that observed but without outliers; this logic forms the basis for the p-value of the outlier test.

## Parallelization in **OutSeekR**

The statistical approach to outlier detection implemented by **OutSeekR** is time-consuming. To reduce runtime, the code in **OutSeekR** has been written to allow parallelization. Parallelization is supported through the use of the package [**future.apply**](https://future.apply.futureverse.org/). **future.apply** is built on top of the future framework implemented by the [**future**](https://future.futureverse.org/) package, which provides a uniform way to parallelize code independent of operating system or computing environment. In particular, **OutSeekR** uses the `future_*apply()` functions defined in **future.apply** rather than their base R equivalents in order to take advantage of a parallelization strategy set with `future::plan()` by the user.

**Note:** Depending on the size of the input data set and the number of null transcripts requested, the objects created by **OutSeekR** may exceed a limit defined in **future** to prevent exporting very large objects, which will trigger an error with a message referring to `future.globals.maxSize`. This can be avoided by setting `future.globals.maxSize` to a large value, e.g., `options(future.globals.maxSize = 8000 * 1024^2);  # = 8 GB`. See [the documentation of `future.options`](https://search.r-project.org/CRAN/refmans/future/html/future.options.html) for further details.

## Output

The output of the main function in **OutSeekR**, `detect.outliers()`, is a named list with the following components:

- `p.values`: a matrix of unadjusted p-values for the outlier test run on each sample for each transcript in the observed data.
- `fdr`: a matrix of false discover rate (FDR)-adjusted p-values for the outlier test run on each sample for each transcript in the observed data.
- `num.outliers.unadjusted`: a vector giving the number of outliers detected for each transcript based on the unadjusted p-values.
- `num.outliers.adjusted`: a vector giving the number of outliers detected for each transcript based on the FDR-adjusted p-values.
- `outlier.test.results.list`: a list of length `max(num.outliers.unadjusted) + 1` containing entries `roundN`, where `N` is between one and `max(num.outliers.unadjusted) + 1`.  `roundN` is the data frame of results for the outlier test after excluding the $(N-1)$th outlier sample, with `round1` being for the original data set (i.e., before excluding any outlier samples).  A transcript will only appear in the data frames up to the total number of outliers in that transcript plus one; for example, a transcript with one outlier will appear in `round1` and `round2`, a transcript with two outliers will appear in `round1`, `round2`, and `round3`.  All transcripts appear in `round1`.
- `distributions`: a numeric vector indicating the optimal distribution for each transcript. Possible values are 1 (normal), 2 (log-normal), 3 (exponential), and 4 (gamma).

In most cases, the matrices `p.values` and `fdr` will contain entries with `NA`. These represent samples for a given transcript where the outlier test was not run because another sample was previously found not to be an outlier. See [Overview] for further explanation.

# Example

**OutSeekR** includes a sample data set called `outliers` that we shall use as an example. It is a data frame consisting of 50 samples across 500 transcripts.

An analysis in **OutSeekR** is run using the function `detect.outliers()`.
